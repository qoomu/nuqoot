<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Fund Connect - Instant IDR Payouts</title>
    
    <!-- Apple Mobile Web App Meta Tags (Kept) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fund Connect">
    <!-- Placeholder for an icon, should be replaced with a real 180x180 PNG -->
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/003366/ffffff?text=GC"> 

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* Light background */
        }
        .container-card {
            /* Restoring the original shadow look */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Custom scrollbar for request history */
        #requestHistory::-webkit-scrollbar {
            width: 6px;
        }
        #requestHistory::-webkit-scrollbar-thumb {
            background-color: #3b82f6;
            border-radius: 3px;
        }
        #requestHistory::-webkit-scrollbar-track {
            background-color: #e5e7eb;
        }
        /* Ensure history area is full height on small screens */
        @media (max-width: 1023px) {
            #requestHistoryContainer {
                max-height: 400px;
            }
        }
    </style>
</head>
<body class="min-h-screen p-4 flex items-start justify-center overflow-x-hidden">

    <div class="w-full max-w-4xl space-y-6 md:space-y-8">
        <!-- Header -->
        <header class="text-center py-6 bg-white container-card rounded-xl">
            <h1 class="3xl sm:text-4xl font-extrabold text-blue-800">Global Fund Connect</h1>
            <p class="text-lg sm:text-xl mt-1 text-gray-600">Effortless Digital Asset Liquidity for IDR Payouts</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
            <!-- Asset Conversion Form -->
            <div id="conversionFormCard" class="bg-white p-6 rounded-xl container-card h-fit">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-5 border-b pb-3">Request Local Payout</h2>
                
                <!-- Auth Status Message (Local Storage Demo) -->
                <div id="authStatus" class="mb-4 p-3 rounded-lg text-sm text-center bg-indigo-100 text-indigo-800">
                    Data stored locally in your browser (Demo Mode).
                </div>

                <form id="conversionForm" class="space-y-4">
                    <!-- Amount Input (The Digital Asset) -->
                    <div>
                        <label for="amountUSD" class="block text-sm font-medium text-gray-700">Digital Value to Convert (USD Equivalent)</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 sm:text-sm font-bold">$</span>
                            </div>
                            <!-- Reverting input classes to V1's aesthetic -->
                            <input type="number" name="amountUSD" id="amountUSD" required min="100" placeholder="Minimum $100"
                                class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-8 pr-12 sm:text-sm border-gray-300 rounded-md p-2">
                        </div>
                    </div>

                    <!-- Payout Method Select (Local Receiver) -->
                    <div>
                        <label for="receiverType" class="block text-sm font-medium text-gray-700">Preferred Local Payout Method (IDR)</label>
                        <!-- Reverting select classes to V1's aesthetic -->
                        <select id="receiverType" name="receiverType" required
                            class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">-- Select Method --</option>
                            <option value="Bank BCA">Bank Transfer (BCA)</option>
                            <option value="Bank Mandiri">Bank Transfer (Mandiri)</option>
                            <option value="Bank BNI">Bank Transfer (BNI)</option>
                            <option value="Gopay">E-Wallet (GoPay)</option>
                            <option value="OVO">E-Wallet (OVO)</option>
                            <option value="Dana">E-Wallet (DANA)</option>
                            <option value="Other">Other Indonesian Bank/E-Wallet</option>
                        </select>
                    </div>

                    <!-- Contact Information -->
                    <div>
                        <label for="contact" class="block text-sm font-medium text-gray-700">Contact for Transaction (Telegram/WhatsApp ID)</label>
                        <!-- Reverting input classes to V1's aesthetic -->
                        <input type="text" name="contact" id="contact" required placeholder="@YourTelegram or +62 8xx"
                            class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2">
                    </div>
                    
                    <button type="submit" id="submitButton"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                        Submit Conversion Request
                    </button>
                    <p class="text-xs text-gray-500 text-center mt-3">By submitting, you agree to our confidential P2P processing terms.</p>
                </form>
            </div>

            <!-- Request History / Status -->
            <div class="bg-white p-6 rounded-xl container-card h-fit">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-5 border-b pb-3">My Request History</h2>
                
                <div id="userInfo" class="text-sm p-3 mb-4 bg-gray-100 text-gray-700 rounded-lg">
                    <p class="font-semibold">Local Session ID (Key):</p> 
                    <span id="displayUserId" class="font-mono text-xs break-all">Initializing...</span>
                </div>

                <div id="requestHistoryContainer" class="max-h-96 lg:max-h-full">
                    <div id="requestHistory" class="space-y-4 h-full overflow-y-auto pr-2">
                        <p id="loadingHistory" class="text-gray-500 text-center">Loading request history from local storage...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Redirection Modal -->
    <div id="redirectModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl max-w-sm sm:max-w-xl w-full p-6 sm:p-8 shadow-2xl">
            <h3 class="text-2xl sm:text-3xl font-bold text-green-600 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Request Submitted!
            </h3>
            <p class="text-gray-700 mb-6 text-sm sm:text-base">Your conversion request has been securely logged locally. The next step is the confidential P2P processing.</p>
            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                <p class="font-semibold text-yellow-800 mb-2">Next Steps (Mandatory):</p>
                <ol class="list-decimal list-inside space-y-1 text-sm text-yellow-700">
                    <li>We will contact you via your provided ID (Telegram/WhatsApp) within minutes.</li>
                    <li>You will be redirected to the secure P2P app to finalize the asset transfer and confirm the local payout details.</li>
                </ol>
            </div>
            <button id="closeModalButton"
                class="mt-6 w-full py-3 px-4 rounded-lg shadow-md text-lg font-medium text-white bg-green-500 hover:bg-green-600 transition duration-150 ease-in-out">
                Proceed to Secure Channel (Simulated)
            </button>
        </div>
    </div>

    <!-- Local Storage JS Logic -->
    <script>
        // Constants
        const LOCAL_STORAGE_KEY_PREFIX = 'gfc_user_requests_';

        // DOM Elements
        const form = document.getElementById('conversionForm');
        const historyContainer = document.getElementById('requestHistory');
        const submitButton = document.getElementById('submitButton');
        const modal = document.getElementById('redirectModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const displayUserId = document.getElementById('displayUserId');
        const loadingHistory = document.getElementById('loadingHistory');

        let userId = null;
        let localStorageKey = null;

        /**
         * Initializes the application, setting up a unique user ID for local storage.
         */
        function initializeApp() {
            // Get or generate a persistent unique ID for this user session
            userId = localStorage.getItem('gfc_session_id');
            if (!userId) {
                userId = crypto.randomUUID();
                localStorage.setItem('gfc_session_id', userId);
            }
            
            localStorageKey = LOCAL_STORAGE_KEY_PREFIX + userId;
            displayUserId.textContent = userId;

            // Load and display initial requests
            renderRequests(getRequestsFromLocalStorage());

            // Since it's local storage, the submit button is always available
            submitButton.disabled = false; 
        }
        
        /**
         * Converts a raw JavaScript timestamp to a readable string.
         * @param {number} timestamp - Unix timestamp (milliseconds)
         * @returns {string} Formatted date string
         */
        function formatTimestamp(timestamp) {
            if (timestamp) {
                return new Date(timestamp).toLocaleString('en-GB', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
            return 'N/A';
        }

        /**
         * Retrieves requests from local storage and sorts them by timestamp.
         * @returns {Array<Object>} Sorted array of request objects.
         */
        function getRequestsFromLocalStorage() {
            const data = localStorage.getItem(localStorageKey);
            let requests = [];
            try {
                // Ensure array handling for initial load
                requests = data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Error parsing local storage data:", e);
                // Clear bad data if parsing fails to prevent errors
                localStorage.removeItem(localStorageKey);
            }
            
            // Sort by timestamp descending (latest first)
            requests.sort((a, b) => b.timestamp - a.timestamp);
            return requests;
        }

        /**
         * Renders the list of conversion requests.
         * @param {Array<Object>} requests - Array of request documents.
         */
        function renderRequests(requests) {
            historyContainer.innerHTML = ''; // Clear existing content
            loadingHistory.classList.add('hidden');

            if (requests.length === 0) {
                historyContainer.innerHTML = '<p class="text-gray-500 text-center p-4 border rounded-lg">No previous requests found. Submit your first one!</p>';
                return;
            }

            requests.forEach(request => {
                let statusClasses = '';
                // Status is hardcoded to Pending in this local demo for simplicity
                const status = request.status || 'Pending'; 
                switch (status) {
                    case 'Pending':
                        statusClasses = 'bg-yellow-100 text-yellow-800';
                        break;
                    case 'Processing':
                        statusClasses = 'bg-blue-100 text-blue-800';
                        break;
                    case 'Completed':
                        statusClasses = 'bg-green-100 text-green-800';
                        break;
                    default:
                        statusClasses = 'bg-gray-100 text-gray-800';
                }

                const requestElement = document.createElement('div');
                requestElement.className = 'p-4 rounded-xl border border-gray-200 bg-gray-50 hover:shadow-md transition duration-150';
                requestElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xl font-semibold text-gray-800">$${request.amountUSD.toLocaleString()}</span>
                        <span class="px-3 py-1 text-xs font-medium rounded-full ${statusClasses}">${status}</span>
                    </div>
                    <p class="text-sm text-gray-600">Payout: <span class="font-medium">${request.receiverType}</span></p>
                    <p class="text-xs text-gray-500 mt-1">Contact: ${request.contact}</p>
                    <p class="text-xs text-gray-400 mt-1">Requested: ${formatTimestamp(request.timestamp)}</p>
                `;
                historyContainer.appendChild(requestElement);
            });
        }

        /**
         * Handles the form submission to save the request to Local Storage.
         * @param {Event} e - The form submission event.
         */
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const data = new FormData(e.target);
            const amountUSD = parseFloat(data.get('amountUSD'));
            const receiverType = data.get('receiverType');
            const contact = data.get('contact');

            if (amountUSD < 100) {
                // Log error for the demo
                console.error('Minimum digital value to convert is $100.');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';

            try {
                const newRequest = {
                    amountUSD: amountUSD,
                    receiverType: receiverType,
                    contact: contact,
                    status: 'Pending', // Default status for local demo
                    timestamp: Date.now(),
                    id: crypto.randomUUID()
                };

                // Retrieve existing requests, add new one, and save back
                const existingRequests = getRequestsFromLocalStorage();
                existingRequests.push(newRequest);
                localStorage.setItem(localStorageKey, JSON.stringify(existingRequests));

                // Re-render the history immediately
                renderRequests(getRequestsFromLocalStorage());

                // Show success modal and reset form
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                form.reset();

            } catch (error) {
                console.error("Error saving to local storage: ", error);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Conversion Request';
            }
        });

        // Close modal and simulate redirection
        closeModalButton.addEventListener('click', () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            console.log("Simulating redirection to P2P processing application...");
        });

        // Initialize everything when the window loads
        window.onload = initializeApp;
    </script>
</body>
</html>
